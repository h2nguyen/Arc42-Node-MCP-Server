{
  "id": "snapshot_1771031663344_vwrj0ero1",
  "approvalId": "approval_1771031663331_hl9rvfx0t",
  "approvalTitle": "Design: Multiple Output Formats (Strategy Pattern Architecture)",
  "version": 1,
  "timestamp": "2026-02-14T01:14:23.344Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Multiple Output Formats\n\n## Overview\n\nThis design document describes the architecture for adding multiple output format support to the Arc42 Node MCP Server. The implementation follows the same Strategy Pattern used by the multi-language feature, providing a pluggable architecture for format handling. The initial implementation adds AsciiDoc format support alongside the existing Markdown functionality, with AsciiDoc as the default format for new projects.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThe design follows these documented patterns and standards:\n\n- **Strategy Pattern**: Output format strategies follow the same pattern as `LanguageStrategy` implementation\n- **Registry Pattern**: `OutputFormatRegistry` matches `LanguageRegistry` for centralized format management\n- **Factory Pattern**: `OutputFormatFactory` matches `LanguageFactory` for format creation with normalization\n- **Facade Pattern**: The template provider will facade format complexity for tools\n- **S.O.L.I.D Principles**: Each component follows SRP, OCP, LSP, ISP, and DIP\n- **DRY Principle**: Format constants and common logic defined once\n\n### Project Structure (structure.md)\n\nThe implementation follows project organization conventions:\n\n```\nsrc/templates/\n├── locales/           # Existing language support\n│   └── ...\n└── formats/           # NEW: Output format support\n    ├── index.ts                        # Format barrel exports\n    ├── output-format-strategy.ts       # OutputFormatStrategy interface\n    ├── output-format-factory.ts        # Factory for creating strategies\n    ├── output-format-registry.ts       # Registry for format strategies\n    ├── markdown/                       # Markdown format\n    │   └── index.ts                    # MarkdownFormatStrategy\n    └── asciidoc/                       # AsciiDoc format\n        └── index.ts                    # AsciiDocFormatStrategy\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **LanguageStrategy pattern**: The same Strategy/Registry/Factory architecture will be adapted for formats\n- **templateProvider**: Will be extended to use format strategies when generating content\n- **types.ts utilities**: `getErrorMessage()`, `resolveWorkspaceRoot()` will be reused\n- **config.yaml handling**: Existing YAML parsing infrastructure will include format settings\n\n### Integration Points\n\n- **arc42-init tool**: Will add `format` parameter, defaulting to \"asciidoc\"\n- **generate-template tool**: Will respect configured format\n- **update-section tool**: Will maintain existing file format\n- **arc42-status tool**: Will detect both `.md` and `.adoc` extensions\n- **LocalizedTemplateProvider**: Will compose with format strategies\n\n## Architecture\n\nThe design adds a format layer that transforms language-agnostic content into format-specific output.\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each format strategy handles one format's syntax\n- **Component Isolation**: Format strategies are independent of each other\n- **Service Layer Separation**: Format strategies only handle syntax, not content\n- **Utility Modularity**: Format utilities are focused and single-purpose\n\n### Architecture Diagram\n\n```mermaid\ngraph TD\n    A[Tool Handlers] --> B[LocalizedTemplateProvider]\n    B --> C[LanguageFactory]\n    B --> D[OutputFormatFactory]\n    C --> E[LanguageRegistry]\n    D --> F[OutputFormatRegistry]\n    E --> G[LanguageStrategy EN/DE/etc]\n    F --> H[OutputFormatStrategy MD/ADOC]\n\n    subgraph \"Language Layer (Existing)\"\n        C\n        E\n        G\n    end\n\n    subgraph \"Format Layer (New)\"\n        D\n        F\n        H\n    end\n```\n\n### Content Flow\n\n```mermaid\nflowchart LR\n    A[Raw Content] --> B[LanguageStrategy]\n    B --> C[Localized Content]\n    C --> D[OutputFormatStrategy]\n    D --> E[Formatted Output]\n\n    style D fill:#90EE90\n    style E fill:#90EE90\n```\n\n## Components and Interfaces\n\n### Component 1: OutputFormatStrategy Interface\n\n- **Purpose**: Defines the contract for all output format implementations\n- **Interfaces**:\n  ```typescript\n  interface OutputFormatStrategy {\n    // Metadata\n    code: OutputFormatCode;      // 'markdown' | 'asciidoc'\n    name: string;                // 'Markdown' | 'AsciiDoc'\n    fileExtension: string;       // '.md' | '.adoc'\n\n    // Syntax conversion\n    formatHeading(text: string, level: number): string;\n    formatBold(text: string): string;\n    formatItalic(text: string): string;\n    formatCode(code: string, language?: string): string;\n    formatInlineCode(text: string): string;\n    formatUnorderedList(items: string[]): string;\n    formatOrderedList(items: string[]): string;\n    formatLink(text: string, url: string): string;\n    formatImage(alt: string, url: string): string;\n    formatTable(headers: string[], rows: string[][]): string;\n    formatBlockquote(text: string): string;\n    formatHorizontalRule(): string;\n    formatAnchor(id: string): string;\n\n    // File generation\n    getReadmeFilename(): string;       // 'README.md' | 'README.adoc'\n    getSectionFilename(section: string): string;\n  }\n  ```\n- **Dependencies**: None (pure interface)\n- **Reuses**: Pattern from `LanguageStrategy` interface\n\n### Component 2: OutputFormatRegistry\n\n- **Purpose**: Stores and retrieves format strategies with O(1) lookup\n- **Interfaces**:\n  ```typescript\n  class OutputFormatRegistry {\n    register(strategy: OutputFormatStrategy): this;\n    get(code: string): OutputFormatStrategy | undefined;\n    getOrThrow(code: string): OutputFormatStrategy;\n    getAll(): OutputFormatStrategy[];\n    isSupported(code: string): boolean;\n    getAvailableCodes(): OutputFormatCode[];\n    getDefault(): OutputFormatStrategy | undefined;\n    get size(): number;\n    clear(): this;\n  }\n  ```\n- **Dependencies**: `OutputFormatStrategy` interface\n- **Reuses**: Implementation pattern from `LanguageRegistry`\n\n### Component 3: OutputFormatFactory\n\n- **Purpose**: Creates format strategy instances with normalization and fallback\n- **Interfaces**:\n  ```typescript\n  class OutputFormatFactory {\n    constructor(registry: OutputFormatRegistry);\n    normalizeCode(code: string): string;\n    create(code: string): OutputFormatStrategy;\n    createWithFallback(code: string): OutputFormatStrategy;  // Falls back to AsciiDoc\n    isSupported(code: string): boolean;\n    getAvailableCodes(): OutputFormatCode[];\n    getDefault(): OutputFormatStrategy;  // Returns AsciiDoc\n  }\n  ```\n- **Dependencies**: `OutputFormatRegistry`\n- **Reuses**: Implementation pattern from `LanguageFactory`\n\n### Component 4: MarkdownFormatStrategy\n\n- **Purpose**: Implements Markdown-specific formatting syntax\n- **Interfaces**: Implements `OutputFormatStrategy`\n- **Dependencies**: `OutputFormatStrategy` interface\n- **Key Syntax**:\n  - Headings: `#`, `##`, `###`, etc.\n  - Bold: `**text**`\n  - Italic: `*text*`\n  - Code blocks: ` ```language `\n  - Lists: `-` for unordered, `1.` for ordered\n  - File extension: `.md`\n\n### Component 5: AsciiDocFormatStrategy\n\n- **Purpose**: Implements AsciiDoc-specific formatting syntax\n- **Interfaces**: Implements `OutputFormatStrategy`\n- **Dependencies**: `OutputFormatStrategy` interface\n- **Key Syntax**:\n  - Headings: `=`, `==`, `===`, etc.\n  - Bold: `*text*`\n  - Italic: `_text_`\n  - Code blocks: `[source,language]` + `----`\n  - Lists: `*` for unordered, `.` for ordered\n  - File extension: `.adoc`\n  - Anchors: `[[id]]`\n\n### Component 6: Extended LocalizedTemplateProvider\n\n- **Purpose**: Provides unified access to localized and formatted templates\n- **Interfaces**:\n  ```typescript\n  class LocalizedTemplateProvider {\n    // Existing methods...\n\n    // New format-aware methods\n    getFormattedTemplate(section: Arc42Section, language?: string, format?: string): string;\n    getFormattedReadmeContent(language?: string, format?: string, projectName?: string): string;\n    getFormatStrategy(format?: string): OutputFormatStrategy;\n    readFormatFromConfig(workspacePath: string): string | undefined;\n  }\n  ```\n- **Dependencies**: `LanguageFactory`, `OutputFormatFactory`\n- **Reuses**: Extends existing `LocalizedTemplateProvider`\n\n## Data Models\n\n### OutputFormatCode Type\n\n```typescript\ntype OutputFormatCode = 'markdown' | 'asciidoc';\n\nconst SUPPORTED_OUTPUT_FORMAT_CODES: readonly OutputFormatCode[] =\n  ['markdown', 'asciidoc'] as const;\n\n// Aliases for normalization\nconst OUTPUT_FORMAT_ALIASES: Record<string, OutputFormatCode> = {\n  'md': 'markdown',\n  'markdown': 'markdown',\n  'adoc': 'asciidoc',\n  'asciidoc': 'asciidoc',\n  'ascii': 'asciidoc',\n  'asciidoctor': 'asciidoc'\n};\n\nconst DEFAULT_OUTPUT_FORMAT: OutputFormatCode = 'asciidoc';\n```\n\n### OutputFormatInfo Type\n\n```typescript\ninterface OutputFormatInfo {\n  code: OutputFormatCode;\n  name: string;\n  fileExtension: string;\n}\n```\n\n### Updated config.yaml Structure\n\n```yaml\nprojectName: My Project\nversion: 1.0.0\ncreated: 2024-01-01T00:00:00.000Z\nformat: asciidoc          # NEW: Output format (default: asciidoc)\nlanguage: EN\narc42_template_version: 8.2\narc42_template_date: January 2023\narc42_template_commit: abc123\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Unknown Format Code**\n   - **Handling**: Log warning, fall back to AsciiDoc\n   - **User Impact**: System continues with default format, warning shown\n\n2. **Invalid Format in Config**\n   - **Handling**: Log warning, use AsciiDoc\n   - **User Impact**: Documentation generated with default format\n\n3. **Format Strategy Not Registered**\n   - **Handling**: Throw descriptive error with available formats\n   - **User Impact**: Clear error message listing valid options\n\n4. **File Extension Mismatch**\n   - **Handling**: Detect existing format from file extension\n   - **User Impact**: Existing files maintain their format\n\n## Testing Strategy\n\n### Unit Testing\n\nEach component will have dedicated unit tests:\n\n- **OutputFormatStrategy tests**: Verify syntax generation for all methods\n- **OutputFormatRegistry tests**: Verify registration, lookup, and enumeration\n- **OutputFormatFactory tests**: Verify normalization, fallback, and creation\n- **MarkdownFormatStrategy tests**: Verify all Markdown syntax conversions\n- **AsciiDocFormatStrategy tests**: Verify all AsciiDoc syntax conversions\n\n### Integration Testing\n\n- Test `arc42-init` creates files in correct format\n- Test `generate-template` produces format-specific output\n- Test `arc42-status` detects both `.md` and `.adoc` files\n- Test format switches mid-project work correctly\n\n### Test File Structure\n\n```\nsrc/__tests__/templates/formats/\n├── output-format-strategy.test.ts\n├── output-format-registry.test.ts\n├── output-format-factory.test.ts\n├── markdown/\n│   └── markdown-strategy.test.ts\n└── asciidoc/\n    └── asciidoc-strategy.test.ts\n```\n\n### Coverage Goals\n\n| Metric | Target |\n|--------|--------|\n| Statements | 80% |\n| Branches | 75% |\n| Functions | 90% |\n| Lines | 80% |\n\n## Tool Parameter Updates\n\n### arc42-init\n\n```typescript\nexport const arc42InitInputSchema = {\n  projectName: z.string().describe('Name of the project'),\n  force: z.boolean().optional(),\n  targetFolder: z.string().optional(),\n  language: z.enum(languageValues).optional().default('EN'),\n  format: z.enum(['markdown', 'asciidoc', 'md', 'adoc'])\n    .optional()\n    .default('asciidoc')  // NEW: Default to AsciiDoc\n    .describe('Output format: markdown (md) or asciidoc (adoc). Defaults to asciidoc.')\n};\n```\n\n### generate-template\n\n```typescript\nexport const generateTemplateInputSchema = {\n  section: z.enum(sectionValues),\n  language: z.enum(languageValues).optional().default('EN'),\n  targetFolder: z.string().optional(),\n  format: z.enum(['markdown', 'asciidoc', 'md', 'adoc'])\n    .optional()\n    .describe('Output format. Defaults to config.yaml setting or asciidoc.')\n};\n```\n\n## Implementation Notes\n\n### Markdown Syntax Reference\n\n| Element | Markdown Syntax |\n|---------|----------------|\n| H1 | `# Title` |\n| H2 | `## Section` |\n| Bold | `**bold**` |\n| Italic | `*italic*` |\n| Code | ` ```lang ` ... ` ``` ` |\n| Inline code | `` `code` `` |\n| Unordered list | `- item` |\n| Ordered list | `1. item` |\n| Link | `[text](url)` |\n| Image | `![alt](url)` |\n| Blockquote | `> quote` |\n| HR | `---` |\n\n### AsciiDoc Syntax Reference\n\n| Element | AsciiDoc Syntax |\n|---------|----------------|\n| H1 | `= Title` |\n| H2 | `== Section` |\n| Bold | `*bold*` |\n| Italic | `_italic_` |\n| Code | `[source,lang]` + `----` |\n| Inline code | `` `code` `` |\n| Unordered list | `* item` |\n| Ordered list | `. item` |\n| Link | `link:url[text]` |\n| Image | `image::url[alt]` |\n| Blockquote | `____` block |\n| HR | `'''` |\n| Anchor | `[[id]]` |\n| Cross-ref | `<<id>>` |\n\n## Migration Considerations\n\n### Existing Markdown Projects\n\nExisting projects with `.md` files will continue to work:\n\n1. Tools detect file extensions to determine format\n2. No automatic migration of existing files\n3. Users can manually convert if desired\n\n### New Projects\n\nNew projects created with `arc42-init`:\n\n1. Default to AsciiDoc format (`.adoc` files)\n2. Users can explicitly request Markdown with `format: \"markdown\"`\n3. Config.yaml stores the chosen format\n\n## Future Extensibility\n\n### Adding New Formats\n\nTo add a new format (e.g., reStructuredText):\n\n1. Create `src/templates/formats/rst/index.ts`\n2. Implement `OutputFormatStrategy` interface\n3. Register in `src/templates/formats/index.ts`\n4. Add tests in `src/__tests__/templates/formats/rst/`\n5. Update `OutputFormatCode` type\n6. Update tool input schemas\n\nThe architecture ensures new formats can be added without modifying existing format implementations (Open/Closed Principle).\n",
  "fileStats": {
    "size": 13692,
    "lines": 431,
    "lastModified": "2026-02-14T01:14:18.552Z"
  },
  "comments": []
}